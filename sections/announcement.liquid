<style type="text/css">
  {% if section.settings.message_show %}
  .announcement {
      background-color: {{ section.settings.message_color_bg }};
  }
  .announcement__text,
  .announcement__text.rte a {
      color: {{ section.settings.message_color_text }};
  }
  .announcement__text.rte a {
      border-color: {{ section.settings.message_color_text }};
  }
  .announcement__timer {
      font-weight: bold;
      line-height: 1;
      margin-left: 5px;
      font-size: 14px;
      display: inline-block;
      padding: 3px;
      background: #ffffff;
      color: #d30202;
      border-radius: 3px;
      min-width: 185px;
      text-align: center;
  }
  {% endif %}
</style>

{% if section.settings.message_show %}
  {% if section.settings.home_page_only == false or template.name == 'index' %}
    {% unless section.settings.message_link == blank %}
    <a href="{{ section.settings.message_link }}" class="announcement__link">
    {% endunless %}
      <div class="announcement js-announcement">
        <p class="announcement__text">{{ section.settings.message_text | escape }}
            {% if section.settings.enable_timer %}
                <span id="announcement-timer-{{ section.id }}" class="announcement__timer"></span>
            {% endif %}
        </p>
        
      </div>
    {% unless section.settings.message_link == blank %}
    </a>
    {% endunless %}
  {% endif %}
{% endif %}

{% if section.settings.enable_timer %}
<script>
(function() {
  const timerId = "announcement-timer-{{ section.id }}";
  const el = document.getElementById(timerId);
  if (!el) return;

  const storageKey = "announcement_timer_data_{{ section.id }}";

  const config = {
    days: {{ section.settings.timer_days | default: 0 }},
    hours: {{ section.settings.timer_hours | default: 0 }},
    minutes: {{ section.settings.timer_minutes | default: 0 }},
  };

  const configHash = JSON.stringify(config);

  let savedData = localStorage.getItem(storageKey);
  let endDate;

  if (savedData) {
    try {
      savedData = JSON.parse(savedData);
    } catch (e) {
      savedData = null;
    }
  }

  if (!savedData || savedData.configHash !== configHash) {
    const newEndDate = new Date();
    newEndDate.setDate(newEndDate.getDate() + config.days);
    newEndDate.setHours(newEndDate.getHours() + config.hours);
    newEndDate.setMinutes(newEndDate.getMinutes() + config.minutes);
    newEndDate.setSeconds(0);

    endDate = newEndDate.getTime();

    localStorage.setItem(storageKey, JSON.stringify({
      configHash: configHash,
      endDate: endDate
    }));
  } else {
    endDate = savedData.endDate;
  }

  function updateTimer() {
    const now = new Date().getTime();
    const distance = endDate - now;

    if (distance <= 0) {
      el.style.display = "none";
      clearInterval(timerInterval);
      return;
    }

    const d = Math.floor(distance / (1000 * 60 * 60 * 24));
    const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const s = Math.floor((distance % (1000 * 60)) / 1000);

    el.innerHTML = `Ends in: ${d}d ${h}h ${m}m ${s}s`;
  }

  updateTimer();
  const timerInterval = setInterval(updateTimer, 1000);
})();
</script>
{% endif %}


{% schema %}
{
  "name": "Announcement bar",
  "class": "js-section__announcement",
  "settings": [
    {
      "type": "checkbox",
      "id": "message_show",
      "label": "Enable announcement bar",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "home_page_only",
      "label": "Home page only",
      "default": false
    },
    {
      "type": "textarea",
      "id": "message_text",
      "label": "Text",
      "default": "Use this announcement bar to share some news and link to page or product."
    },
    {
      "type": "url",
      "id": "message_link",
      "label": "Link"
    },
    {
      "type": "color",
      "id": "message_color_bg",
      "label": "Background color",
      "default": "#212121"
    },
    {
      "type": "color",
      "id": "message_color_text",
      "label": "Text color",
      "default": "#FFFFFF"
    },
    {
      "type": "checkbox",
      "id": "enable_timer",
      "label": "Show countdown timer",
      "default": false
    },
    {
      "type": "number",
      "id": "timer_days",
      "label": "Days until promotion ends",
      "default": 9,
    },
    {
      "type": "number",
      "id": "timer_hours",
      "label": "Hours",
      "default": 0
    },
    {
      "type": "number",
      "id": "timer_minutes",
      "label": "Minutes",
      "default": 0
    }
  ]
}
{% endschema %}
